version: "3.9"

networks:
  docker-direct:
    external: true
  docker-vpn:
    external: true

services:
  caddy:
    container_name: caddy
    image: lucaslorentz/caddy-docker-proxy:alpine
    restart: unless-stopped
    hostname: caddy
    environment:
      - CADDY_INGRESS_NETWORKS=docker-direct,docker-vpn
    networks:
      docker-direct:
        ipv4_address: 10.10.2.4
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - $DATA_DIR/caddy_data/:/data
    labels:
      caddy.local_certs:

  unbound:
    container_name: unbound
    image: mvance/unbound:latest
    restart: unless-stopped
    hostname: unbound
    networks:
      docker-direct:
        ipv4_address: 10.10.2.3

  pihole:
    container_name: pihole
    hostname: pihole
    image: pihole/pihole:latest
    restart: unless-stopped
    networks:
      docker-direct:
        ipv4_address: 10.10.2.2
    depends_on:
      - unbound
      - caddy
    environment:
      - PIHOLE_DNS_=unbound
      - WEBTHEME="default-dark"
      - WEBPASSWORD=pihole
      - ADMIN_EMAIL
    volumes:
      - '$DATA_DIR/pihole/etc-pihole:/etc/pihole'
      - '$DATA_DIR/pihole/etc-dnsmasq.d:/etc/dnsmasq.d'
    labels:
      caddy: pihole.hub
      caddy.tls: internal
      caddy.redir: / /admin
      caddy.reverse_proxy: "{{upstreams 80}}"

  bitwarden:
    image: vaultwarden/server:alpine
    container_name: bitwarden
    hostname: bitwarden
    restart: unless-stopped
    user: $PUID:$PGID
    networks:
      - docker-direct
    volumes:
      - $DATA_DIR/bitwarden/:/data
    environment:
      - WEBSOCKET_ENABLED=true
      - DOMAIN=https://bitwarden.hub
      - SIGNUPS_ALLOWED=false
      - ADMIN_TOKEN=admin
      - SIGNUPS_VERIFY=true
      - INVITATIONS_ALLOWED=true
      - SMTP_HOST=mail.$DOMAIN
      - SMTP_FROM=bitwarden@$DOMAIN
      - SMTP_FROM_NAME=Bitwarden
      - SMTP_PORT=587
      - SMTP_SSL="true
      - SMTP_USERNAME=bitwarden@$DOMAIN
      - SMTP_PASSWORD
    healthcheck:
      test: curl -f http://bitwarden:80 &> /dev/null && echo "OK" || exit 1
      interval: 5s
    labels:
      caddy: bitwarden.hub
      caddy.reverse_proxy_0: "{{upstreams 80}}"
      caddy.tls: internal
      caddy.encode: gzip
      caddy.header.X-XSS-Protection: '"1; mode=block;"'
      caddy.header.X-Frame-Options: "DENY"
      caddy.header.X-Content-Type-Options: "none"
      caddy.reverse_proxy_1: "/notifications/hub/negotiate {{upstreams 80}}"
      caddy.reverse_proxy_2: "/notifications/hub {{upstreams 3012}}"

  archiver:
    image: vedhavyas/archiver:latest
    container_name: archiver
    hostname: archiver
    pull_policy: always
    # we need to give root access
    user: root:root
    networks:
      - docker-direct
    volumes:
      - $DATA_DIR:$DATA_DIR
      - $HUB_DIR/backups/hub:$HUB_DIR/backups/hub
    restart: unless-stopped
    environment:
      - SRC=$DATA_DIR
      - BACKUP=$HUB_DIR/backups/hub

  certbot:
    image: vedhavyas/certbot:latest
    container_name: certbot
    hostname: certbot
    pull_policy: always
    networks:
      docker-direct:
        ipv4_address: 10.10.2.7
    volumes:
      - ${DATA_DIR}/certbot/certs:/etc/letsencrypt
      - ${DATA_DIR}/certbot/logs:/var/log/letsencrypt
    restart: unless-stopped
    environment:
      - ADMIN_EMAIL
      - DOMAINS=mail.$DOMAIN

  whoogle:
    container_name: whoogle
    hostname: whoogle
    image: benbusby/whoogle-search:latest
    restart: unless-stopped
    user: whoogle
    networks:
      - docker-vpn
    environment:
      - HTTPS_ONLY=1
      - WHOOGLE_AUTOCOMPLETE=1
      - WHOOGLE_CSP=1
      - WHOOGLE_TOR_SERVICE=0
      - WHOOGLE_CONFIG_THEME=system
      - WHOOGLE_CONFIG_NEW_TAB=1
      - WHOOGLE_CONFIG_VIEW_IMAGE=1
      - WHOOGLE_CONFIG_URL=https://search.hub/
      - WHOOGLE_CONFIG_LANGUAGE=lang_en
      - WHOOGLE_CONFIG_SEARCH_LANGUAGE=lang_en
    volumes:
      - '$DATA_DIR/whoogle:/config'
    tmpfs:
      - /config/:size=10M,uid=927,gid=927,mode=1700
      - /var/lib/tor/:size=10M,uid=927,gid=927,mode=1700
      - /run/tor/:size=1M,uid=927,gid=927,mode=1700
    labels:
      caddy: search.hub
      caddy.tls: internal
      caddy.reverse_proxy: "{{upstreams 5000}}"
